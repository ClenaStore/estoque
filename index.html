<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Balan√ßa Felizola - Sa√≠das</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
<style>
:root {
  --bg:#0b0f19;--card:#151d2f;--accent:#b8860b;
  --text:#f8fafc;--muted:#94a3b8;
}
body {
  margin:0;font-family:Inter,sans-serif;background:var(--bg);
  color:var(--text);text-align:center;padding:20px;
}
header{margin-top:10px;}
h1{color:var(--accent);margin:10px 0;}
#video{width:100%;max-width:380px;border-radius:12px;display:none;
  margin-top:15px;box-shadow:0 0 10px #000a;}
button{
  background:var(--accent);border:none;color:#fff;font-weight:600;
  font-size:16px;border-radius:10px;padding:14px 24px;margin-top:12px;
}
.card{
  background:var(--card);padding:20px;border-radius:12px;margin-top:20px;
  max-width:400px;margin-inline:auto;
}
#status{margin-top:10px;color:var(--muted);}
</style>
</head>
<body>
<header>
  <h1>üì¶ Sa√≠das - Balan√ßa Felizola</h1>
</header>

<video id="video" autoplay playsinline muted></video>
<p id="status">Toque abaixo para abrir a c√¢mera.</p>
<button id="btnAbrir">üé• Abrir C√¢mera</button>

<div id="info" class="card" style="display:none;">
  <h3 id="nome"></h3>
  <p>Peso: <span id="peso"></span> kg</p>
  <p>Pre√ßo: R$ <span id="preco"></span></p>
  <button id="btnRegistrar">Registrar Sa√≠da</button>
</div>

<script type="module">
import { BrowserMultiFormatReader }
  from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/index.min.js";

const video=document.getElementById("video");
const status=document.getElementById("status");
const btnAbrir=document.getElementById("btnAbrir");
const info=document.getElementById("info");
const btnRegistrar=document.getElementById("btnRegistrar");
let reader=new BrowserMultiFormatReader();
let produto=null;

btnAbrir.addEventListener("click",async()=>{
  try{
    status.innerText="Solicitando permiss√£o...";
    btnAbrir.style.display="none";
    const stream=await navigator.mediaDevices.getUserMedia({
      video:{facingMode:{ideal:"environment"},width:{ideal:1280},height:{ideal:720}},
      audio:false
    });
    video.srcObject=stream;
    await video.play();
    video.style.display="block";
    status.innerText="C√¢mera ativa ‚úÖ Aponte para o c√≥digo da etiqueta.";
    iniciarLeitura();
  }catch(e){
    console.error(e);
    status.innerHTML=`‚ö†Ô∏è Erro ao acessar c√¢mera: ${e.name} - ${e.message}`;
    btnAbrir.style.display="block";
  }
});

function iniciarLeitura(){
  reader.decodeFromVideoDevice(null,"video",async(result,err)=>{
    if(result){
      const codigo=result.getText().trim();
      status.innerText="C√≥digo detectado: "+codigo;
      await buscarProduto(codigo);
      reader.reset();
    }
  });
}

async function buscarProduto(codigo){
  const res=await fetch(`/api/ler?codigo=${codigo}`);
  const data=await res.json();
  if(data.nome){
    produto=data;
    info.style.display="block";
    document.getElementById("nome").innerText=data.nome;
    document.getElementById("peso").innerText=data.pesoKg.toFixed(3);
    document.getElementById("preco").innerText=data.valor.toFixed(2);
  }else{
    status.innerText="Produto n√£o encontrado.";
  }
}

btnRegistrar.addEventListener("click",async()=>{
  if(!produto)return;
  const resp=await fetch("/api/registrar",{
    method:"POST",headers:{"Content-Type":"application/json"},
    body:JSON.stringify(produto)
  });
  const data=await resp.json();
  alert(data.ok?"‚úÖ Sa√≠da registrada!":"‚ö†Ô∏è Falha ao registrar!");
  info.style.display="none";
  produto=null;
  status.innerText="Pronto para novo c√≥digo.";
  iniciarLeitura();
});
</script>
</body>
</html>
