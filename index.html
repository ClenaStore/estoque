<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Sa√≠das - Balan√ßa Felizola</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">

<style>
:root {
  --bg: #0b0f19;
  --card: #151d2f;
  --accent: #b8860b;
  --text: #f8fafc;
  --muted: #94a3b8;
}
*{box-sizing:border-box;}
body {
  margin:0;
  font-family: 'Inter', sans-serif;
  background: var(--bg);
  color: var(--text);
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 20px;
}
header {
  text-align: center;
  margin-bottom: 10px;
}
header img {
  width: 80px;
  height: 80px;
  border-radius: 50%;
  border: 2px solid var(--accent);
}
h1 {
  color: var(--accent);
  margin: 10px 0;
  font-size: 1.4rem;
}
#video {
  width: 100%;
  max-width: 400px;
  border-radius: 12px;
  margin-top: 10px;
  display: none;
  box-shadow: 0 0 8px #000;
}
.card {
  background: var(--card);
  padding: 20px;
  border-radius: 16px;
  box-shadow: 0 0 12px #0007;
  max-width: 420px;
  width: 100%;
  margin-top: 15px;
  text-align: center;
}
#status {
  color: var(--muted);
  margin-top: 10px;
}
.info {
  margin-top: 10px;
  background: #0f172a;
  border-radius: 12px;
  padding: 15px;
}
.info h3 {
  color: var(--accent);
  margin: 5px 0;
}
.info p {
  margin: 4px 0;
  color: var(--text);
}
button {
  background: var(--accent);
  color: #fff;
  font-weight: 600;
  border: none;
  border-radius: 10px;
  padding: 12px 20px;
  margin-top: 10px;
  cursor: pointer;
}
</style>
</head>

<body>
<header>
  <img src="https://cdn-icons-png.flaticon.com/512/1046/1046784.png" alt="Logo">
  <h1>Sa√≠das - Balan√ßa Felizola</h1>
</header>

<div class="card">
  <video id="video" autoplay playsinline muted></video>
  <p id="status">Inicializando c√¢mera...</p>

  <div id="info" class="info" style="display:none;">
    <h3 id="nome"></h3>
    <p>Peso: <span id="peso"></span> kg</p>
    <p>Pre√ßo: R$ <span id="preco"></span></p>
    <button id="btnRegistrar">Registrar Sa√≠da</button>
  </div>
</div>

<script type="module">
import { BrowserMultiFormatReader } 
  from "https://cdn.jsdelivr.net/npm/@zxing/library@0.20.0/esm/index.min.js";

const video = document.getElementById("video");
const statusTxt = document.getElementById("status");
const infoBox = document.getElementById("info");
const btnRegistrar = document.getElementById("btnRegistrar");
let reader = new BrowserMultiFormatReader();
let produtoAtual = null;

// üöÄ Ao carregar a p√°gina, tenta abrir a c√¢mera automaticamente
window.addEventListener("load", async () => {
  try {
    const stream = await navigator.mediaDevices.getUserMedia({
      video: { facingMode: { ideal: "environment" } },
      audio: false
    });

    video.srcObject = stream;
    await video.play();
    video.style.display = "block";
    statusTxt.innerText = "C√¢mera ativa ‚úÖ Aponte para o c√≥digo da etiqueta.";

    iniciarLeitura();
  } catch (err) {
    console.error("Erro c√¢mera:", err);
    statusTxt.innerHTML = `
      ‚ö†Ô∏è N√£o foi poss√≠vel abrir a c√¢mera.<br>
      Verifique permiss√µes no navegador.<br><br>
      Erro: ${err.name} - ${err.message}
    `;
  }
});

// üîç Leitura autom√°tica de c√≥digo de barras
function iniciarLeitura() {
  reader.decodeFromVideoDevice(null, 'video', async (result, err) => {
    if (result) {
      const codigo = result.getText().trim();
      console.log("C√≥digo lido:", codigo);
      statusTxt.innerText = "C√≥digo detectado: " + codigo;
      await buscarProduto(codigo);
      reader.reset(); // pausa ap√≥s leitura (remova se quiser cont√≠nuo)
    }
  });
}

// üì¶ Busca produto no backend
async function buscarProduto(codigo) {
  try {
    const res = await fetch(`/api/ler?codigo=${codigo}`);
    const data = await res.json();

    if (data.nome) {
      produtoAtual = data;
      infoBox.style.display = "block";
      document.getElementById("nome").innerText = data.nome;
      document.getElementById("peso").innerText = data.pesoKg.toFixed(3);
      document.getElementById("preco").innerText = data.valor.toFixed(2);
    } else {
      statusTxt.innerText = "Produto n√£o encontrado.";
    }
  } catch (e) {
    alert("Erro ao buscar produto: " + e);
  }
}

// üíæ Registrar sa√≠da
btnRegistrar.addEventListener("click", async () => {
  if (!produtoAtual) return;
  const resp = await fetch("/api/registrar", {
    method: "POST",
    headers: {"Content-Type": "application/json"},
    body: JSON.stringify(produtoAtual)
  });
  const data = await resp.json();
  if (data.ok) {
    alert("‚úÖ Sa√≠da registrada!");
    infoBox.style.display = "none";
    produtoAtual = null;
    statusTxt.innerText = "Pronto para novo c√≥digo.";
    iniciarLeitura();
  } else {
    alert("‚ö†Ô∏è Erro ao registrar sa√≠da!");
  }
});
</script>
</body>
</html>
